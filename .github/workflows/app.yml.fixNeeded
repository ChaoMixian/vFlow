# éœ€è¦ä¿®å¤ç­¾åé—®é¢˜ï¼Œæš‚æ—¶ç¦ç”¨
name: Android CI/CD

on:
  push:
    tags:
      - 'v*'  # æ¨é€ v1.3.6 ç­‰ tag æ—¶è§¦å‘
    branches:
      - '**'  # æ¨é€ä»»æ„åˆ†æ”¯æ—¶è§¦å‘

jobs:
  build:
    name: Build APKs
    runs-on: ubuntu-latest
    permissions:
      contents: write # å…è®¸åˆ›å»º Release

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å¿…é¡»è®¾ä¸º 0ï¼Œå¦åˆ™æ— æ³•è·å– commit log ç”Ÿæˆæ›´æ–°æ—¥å¿—

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ä½¿ç”¨å®˜æ–¹ Gradle Actionï¼Œè‡ªå¸¦æ„å»ºç¼“å­˜åŠŸèƒ½
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper

      # 1. æ¢å¤ç­¾åæ–‡ä»¶ (ä»…åœ¨ Secrets å­˜åœ¨æ—¶æ‰§è¡Œï¼Œé˜²æ­¢ Fork ä»“åº“æŠ¥é”™)
      - name: Decode Keystore
        env:
          ENCODED_KEYSTORE: ${{ secrets.KEYSTORE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEYSTORE_ALIAS: ${{ secrets.KEYSTORE_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          if [ -n "$ENCODED_KEYSTORE" ]; then
            echo "Decoding Keystore..."
            # ç”Ÿæˆåˆ°æ ¹ç›®å½•
            echo "$ENCODED_KEYSTORE" | base64 --decode > key.jks
          
            # ç”Ÿæˆé…ç½®æ–‡ä»¶åˆ°æ ¹ç›®å½•
            echo "KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD" > signing.properties
            echo "KEYSTORE_ALIAS=$KEYSTORE_ALIAS" >> signing.properties
            echo "KEY_PASSWORD=$KEY_PASSWORD" >> signing.properties
          else
            echo "Warning: secrets.KEYSTORE is not defined. Skipping signing configuration."
          fi

      # 2. æ‰§è¡Œç¼–è¯‘ (åŒæ—¶ç”Ÿæˆ Debug å’Œ Releaseï¼ŒåŒ…å«æ‰€æœ‰æ¶æ„)
      - name: Build with Gradle
        run: ./gradlew assembleDebug assembleRelease

      # 3. æ ¸å¿ƒæ­¥éª¤ï¼šé‡å‘½å APK
      - name: Rename APKs
        id: rename_apks
        run: |
          # å‡†å¤‡å˜é‡
          DATE_STR=$(date +'%Y%m%d')
          COMMIT_HASH=$(echo ${{ github.sha }} | cut -c1-8)
          IS_TAG=${{ startsWith(github.ref, 'refs/tags/') }}
          
          # å¦‚æœæ˜¯ Tag (v1.3.6)ï¼Œæå–æ•°å­—ç‰ˆæœ¬å· (136)
          if [ "$IS_TAG" = "true" ]; then
            TAG_NAME=${{ github.ref_name }}
            VERSION_STR=$(echo $TAG_NAME | sed 's/[^0-9]//g') # æå–çº¯æ•°å­—
            echo "Building Release for Tag: $TAG_NAME (Version Code: $VERSION_STR)"
          else
            echo "Building for Commit: $COMMIT_HASH"
          fi

          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p final_apks

          # éå†æ‰€æœ‰ç”Ÿæˆçš„ APK æ–‡ä»¶
          # æ’é™¤ä¸­é—´æ–‡ä»¶ï¼Œåªæ‰¾ outputs ç›®å½•ä¸‹çš„ apk
          find . -name "*.apk" -path "*/build/outputs/apk/*" | while read apk_file; do
            echo "Processing: $apk_file"
          
            # åˆ¤æ–­æ„å»ºç±»å‹ (Debug / Release)
            if [[ "$apk_file" == *"release"* ]]; then
              BUILD_TYPE="Release"
            else
              BUILD_TYPE="Debug"
            fi
          
            # åˆ¤æ–­æ¶æ„ (universal, arm64-v8a, etc...)
            if [[ "$apk_file" == *"universal"* ]]; then
              ARCH="universe"
            elif [[ "$apk_file" == *"arm64-v8a"* ]]; then
              ARCH="arm64-v8a"
            elif [[ "$apk_file" == *"armeabi-v7a"* ]]; then
              ARCH="armeabi-v7a"
            elif [[ "$apk_file" == *"x86_64"* ]]; then
              ARCH="x86_64"
            elif [[ "$apk_file" == *"x86"* ]]; then
              ARCH="x86"
            else
              # å¦‚æœæ²¡æœ‰ splitï¼Œé€šå¸¸å°±æ˜¯ universal
              ARCH="universe"
            fi
          
            # æ‹¼æ¥æ–°æ–‡ä»¶å
            if [ "$IS_TAG" = "true" ]; then
              # æ ¼å¼: vFlow_136_Release_universe.apk
              NEW_NAME="vFlow_${VERSION_STR}_${BUILD_TYPE}_${ARCH}.apk"
            else
              # æ ¼å¼: vFlow_20260113_c13bb95d_Release_universe.apk
              NEW_NAME="vFlow_${DATE_STR}_${COMMIT_HASH}_${BUILD_TYPE}_${ARCH}.apk"
            fi
          
            # ç§»åŠ¨å¹¶é‡å‘½å
            cp "$apk_file" "final_apks/$NEW_NAME"
            echo "Renamed to: $NEW_NAME"
          done

      # 4. ä¸Šä¼ æ„å»ºäº§ç‰© (Artifact)
      # ä¸Šä¼  Release - universe
      - name: Upload Release universe
        uses: actions/upload-artifact@v4
        with:
          name: vFlow-Release-universe-${{ github.sha }}
          path: final_apks/*_Release_universe.apk
          retention-days: 90

      # ä¸Šä¼  Release - arm64-v8a
      - name: Upload Release arm64-v8a
        uses: actions/upload-artifact@v4
        with:
          name: vFlow-Release-arm64-v8a-${{ github.sha }}
          path: final_apks/*_Release_arm64-v8a.apk
          retention-days: 90

      # ä¸Šä¼  Release - armeabi-v7a
      - name: Upload Release armeabi-v7a
        uses: actions/upload-artifact@v4
        with:
          name: vFlow-Release-armeabi-v7a-${{ github.sha }}
          path: final_apks/*_Release_armeabi-v7a.apk
          retention-days: 90

      # ä¸Šä¼  Release - x86
      - name: Upload Release x86
        uses: actions/upload-artifact@v4
        with:
          name: vFlow-Release-x86-${{ github.sha }}
          path: final_apks/*_Release_x86*.apk
          retention-days: 90

      # ä¸Šä¼  Debug - universe
      - name: Upload Debug universe
        uses: actions/upload-artifact@v4
        with:
          name: vFlow-Debug-universe-${{ github.sha }}
          path: final_apks/*_Debug_universe.apk
          retention-days: 90

      # ä¸Šä¼  Debug - arm64-v8a
      - name: Upload Debug arm64-v8a
        uses: actions/upload-artifact@v4
        with:
          name: vFlow-Debug-arm64-v8a-${{ github.sha }}
          path: final_apks/*_Debug_arm64-v8a.apk
          retention-days: 90

      # ä¸Šä¼  Debug - armeabi-v7a
      - name: Upload Debug armeabi-v7a
        uses: actions/upload-artifact@v4
        with:
          name: vFlow-Debug-armeabi-v7a-${{ github.sha }}
          path: final_apks/*_Debug_armeabi-v7a.apk
          retention-days: 90

      # ä¸Šä¼  Debug - x86
      - name: Upload Debug x86
        uses: actions/upload-artifact@v4
        with:
          name: vFlow-Debug-x86-${{ github.sha }}
          path: final_apks/*_Debug_x86*.apk
          retention-days: 90

      # 5. ç”Ÿæˆ Release è¯´æ˜ (åŒ…å«ä¸‹è½½è¡¨æ ¼å’Œæ›´æ–°æ—¥å¿—)
      - name: Generate Release Notes
        if: startsWith(github.ref, 'refs/tags/')
        id: release_notes
        run: |
          # 1. åŸºç¡€å˜é‡è®¡ç®—
          TAG_NAME=${{ github.ref_name }}
          # æå–çº¯æ•°å­— (v1.3.6 -> 136)
          VERSION_CODE=$(echo $TAG_NAME | sed 's/[^0-9]//g')
          # è®¾ç½® Release æ ‡é¢˜å˜é‡
          echo "RELEASE_TITLE=vFlow_${VERSION_CODE}" >> $GITHUB_ENV
          
          # 2. æ„å»ºä¸‹è½½é“¾æ¥çš„åŸºç¡€ URL
          # æ ¼å¼: https://github.com/USER/REPO/releases/download/TAG/FILENAME
          BASE_URL="https://github.com/${{ github.repository }}/releases/download/$TAG_NAME"
          
          # å®šä¹‰æ–‡ä»¶å (å¿…é¡»ä¸ Step 3 ä¸­çš„é‡å‘½åé€»è¾‘å®Œå…¨ä¸€è‡´)
          FILE_UNI="vFlow_${VERSION_CODE}_Release_universe.apk"
          FILE_ARM64="vFlow_${VERSION_CODE}_Release_arm64-v8a.apk"
          FILE_ARMV7="vFlow_${VERSION_CODE}_Release_armeabi-v7a.apk"
          FILE_X86_64="vFlow_${VERSION_CODE}_Release_x86_64.apk"
          FILE_DEBUG="vFlow_${VERSION_CODE}_Debug_universe.apk"

          # 3. æ„å»º Markdown è¡¨æ ¼
          # ä½¿ç”¨ EOF å—æ¥æ„å»ºå¤šè¡Œå­—ç¬¦ä¸²
          DOWNLOAD_TABLE=$(cat <<EOF
          ## ğŸ“¥ ä¸‹è½½åœ°å€ (Downloads)

          > **ğŸ‰ å¦‚æœä½ ä¸æ¸…æ¥šè¿™äº›ï¼Œè¯·ç›´æ¥ä¸‹è½½ç¬¬ä¸€è¡Œçš„ "Universal" ç‰ˆæœ¬ã€‚**

          | ç‰ˆæœ¬ (Type) | æ¶æ„ (Arch) | è¯´æ˜ (Description) | ä¸‹è½½ (Link) |
          | :--- | :--- | :--- | :--- |
          | **Release** | **Universal** | ğŸŒŸ **æ¨è**ã€‚åŒ…å«æ‰€æœ‰æ¶æ„ï¼Œå…¼å®¹æ€§æœ€å¥½ï¼Œå®‰è£…æ— å¿§ã€‚ | [**ç‚¹å‡»ä¸‹è½½**]($BASE_URL/$FILE_UNI) |
          | Release | arm64-v8a | âš¡ï¸ **ç°ä»£æ‰‹æœº**ã€‚ä½“ç§¯è¾ƒå°ï¼Œé€‚ç”¨äºè¿‘5å¹´çš„ä¸»æµå®‰å“æœºã€‚ | [ç‚¹å‡»ä¸‹è½½]($BASE_URL/$FILE_ARM64) |
          | Release | armeabi-v7a | ğŸ“± **è€æ—§æ‰‹æœº**ã€‚é€‚ç”¨äºè¾ƒè€çš„è®¾å¤‡æˆ–ç‰¹æ®Šæœºå‹ã€‚ | [ç‚¹å‡»ä¸‹è½½]($BASE_URL/$FILE_ARMV7) |
          | Release | x86_64 | ğŸ’» **æ¨¡æ‹Ÿå™¨**ã€‚é€‚ç”¨äºPCä¸Šçš„å®‰å“æ¨¡æ‹Ÿå™¨ã€‚ | [ç‚¹å‡»ä¸‹è½½]($BASE_URL/$FILE_X86_64) |
          | Debug | Universal | ğŸ **è°ƒè¯•ç‰ˆ**ã€‚åŒ…å«è°ƒè¯•æ—¥å¿—ï¼Œæœªæ··æ·†ï¼Œç”¨äºæ’æŸ¥ Bugã€‚ | [ç‚¹å‡»ä¸‹è½½]($BASE_URL/$FILE_DEBUG) |
          
          EOF
          )

          # 4. è·å– Git Commit æ—¥å¿— (æ›´æ–°æ—¥å¿—)
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found. Using all commits."
            LOGS=$(git log --pretty=format:"* %s (%h)")
          else
            echo "Generating notes from $PREV_TAG to ${{ github.ref_name }}"
            LOGS=$(git log --pretty=format:"* %s (%h)" $PREV_TAG..HEAD)
          fi
          
          # 5. ç»„åˆæœ€ç»ˆå†…å®¹å¹¶å†™å…¥ç¯å¢ƒå˜é‡
          echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "## ğŸ“ æ›´æ–°æ—¥å¿— (Changelog)" >> $GITHUB_ENV
          echo "$LOGS" >> $GITHUB_ENV
          echo "$DOWNLOAD_TABLE" >> $GITHUB_ENV
          echo "## æœ‰é—®é¢˜å¯ä»¥åŠ Qç¾¤ï¼š758795233" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # 6. å‘å¸ƒ Release (ä»… Tag)
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: final_apks/*
          name: ${{ env.RELEASE_TITLE }}
          body: ${{ env.RELEASE_BODY }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}